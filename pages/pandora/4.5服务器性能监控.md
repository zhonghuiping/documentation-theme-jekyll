<article class="markdown-section" id="main"><p>系统运维监控 - 使用 Pandora 智能日志管理平台快速构建服务器性能监控系统</p><p>服务器监控是每个互联网厂商都重视并且想要尽可能做好的事情，从数据收集、数据处理、数据可视化最终再到实时监控告警，这一系列复杂的流程可能耗费企业大量的人力和时间，以至于某些时候因为其复杂性高无法达到预期的监控效果。而当事故发生时才发现，由于监控体系的不完善造成了很多不必要的损失, 让我们追悔莫及。</p><p>为了解决企业的此类烦恼，七牛智能日志管理平台推出了快速构建服务器性能监控报警的解决方案。通过七牛智能日志采集工具 <code>logkit Pro</code> ，可以方便地采集大量服务器的海量性能指标数据，然后接入 Grafana 进行全方位监控。而整个部署和使用的流程，您完整体验的时间仅需 15 分钟。</p><h2 id="监控的内容"><span>监控的内容</span></h2><p><code>logkit Pro</code> 目前收集的机器性能指标主要包括十大模块, 上百个指标</p><ul>
<li><code>system</code> 模块: 监控 <code>load1</code>、<code>load5</code>、<code>load15</code>、<code>用户数</code>、<code>cpu 核数</code>以及<code>系统启动时间</code>等.</li>
<li><code>processes</code> 模块: 监控处于各种状态的进程数量, 比如<code>运行中</code>/<code>暂停</code>/<code>可中断</code>/<code>空闲</code>/<code>挂起</code>等状态的进程数量等等.</li>
<li><code>netstat</code>: 监控处于各种状态的网络连接数, 比如<code>syn send</code>/<code>syn recv</code> 等状态的网络连接数.</li>
<li><code>net</code>: 监控网络设备的状态，比如<code>收发包的数量</code>、<code>收发包的字节数</code>等.</li>
<li><code>mem</code>: 监控内存的实时状态.</li>
<li><code>swap</code>: 监控 swap 分区的状态，比如<code>换入</code>、<code>换出</code>、<code>使用率</code>、<code>空闲大小</code>等.</li>
<li><code>cpu</code>: 监控 CPU 的实时状态，包括<code> cpu 用量</code>，<code>中断时间占比</code>等.</li>
<li><code>kernel</code>: 监控内核中断次数、上下文切换次数、fork 的进程数等.</li>
<li><code>disk</code>: 监控磁盘的使用情况, 包括<code>磁盘用量</code>、<code>inode 使用情况</code>等.</li>
<li><code>diskio</code>: 监控磁盘读写状态, 包括<code>读写次数</code>、<code>总用时</code>等.</li>
</ul>
<h2 id="监控效果图"><span>监控效果图</span></a></h2><p>部署完成后，您可以直接载入我们为您构建的监控模板，最终看到的效果图如下。</p><h3 id="_1-模板变量"><span>1. 模板变量</span></h3><p>模板变量可以起到过滤数据的作用, 比如通过<code> hostname </code>这个模板变量可以具体查看某台特定的服务器上的<code> metric </code>信息，这样即使有数十上百台机器您也可以轻松管理。同样的，对于某台机器的一些具体的资源，如磁盘、CPU、网卡等等，也有相应的模板变量可以选择。

模板变量详情请阅读<a href="/insight/manual/4693/grafana#3"> Grafana 模板变量</a>。

<img src="https://pandora-dl.qiniu.com/grafana_templat.png" data-origin="https://pandora-dl.qiniu.com/grafana_templat.png" alt="template"></p><h3 id="_2-全局概览"><span>2. 全局概览</span></h3><p>全局信息概览可以看到服务器的一些基本信息，比如系统 load 值、内存使用率、磁盘使用率、网络带宽等。以最直观的方式全局把控整个系统的运行状态，方便在基础资源不够时及时发现、及时处理。
<img src="https://pandora-dl.qiniu.com/grafana_overview.png" data-origin="https://pandora-dl.qiniu.com/grafana_overview.png" alt="基本信息概览"></p><h3 id="_3-cpu-usage-信息"><span>3. CPU Usage 信息</span></h3><p>CPU Usage 顾名思义，就是指 CPU 的使用率，通过这幅图可以看到系统中 <code>user</code>、<code>system</code> 等对于系统 CPU 资源的占用情况。当 CPU 使用率较高且整体运行平稳时，说明您的业务非常健康；若 CPU 的用量曲线波动较大，那就说明服务有可以优化的地方，或者可以添加报警，在业务高峰时及时添加资源。
<img src="https://pandora-dl.qiniu.com/grafana_cpu_usage.png" data-origin="https://pandora-dl.qiniu.com/grafana_cpu_usage.png" alt="CPU Usage 概览"></p><h3 id="_4-系统-load-值与进程"><span>4. 系统 load 值与进程</span></h3><p>在这张图中你可以看到不同的统计时间段中系统的负载情况，可以根据负载大小设置告警阈值。同时也可以看到对应的进程数量, 如运行的进程数、在休眠中的进程数，并且可以看到值得关注的一些异常进程，如僵尸进程(zombies)以及被阻塞的进程(blocked)。当存在僵尸进程时说明存在服务异常，需要及时关注并处理。
<img src="https://pandora-dl.qiniu.com/grafana_load_process.png" data-origin="https://pandora-dl.qiniu.com/grafana_load_process.png" alt="load与process"></p><h3 id="_5-内存用量"><span>5. 内存用量</span></h3><p>通过这张图可以看到总内存(total)、已使用内存(used)、空闲内存(free)等信息, 同理, 也可以针对这些信息设置告警，及时发现系统性能短板。另一方面要注意，当系统<code>free</code>的内存少或接近零，而<code>cache</code>部分的内存多时，说明这部分业务对内存缓存较为依赖，虽然服务仍然可以正常运行，但此时极有可能程序没法最大限度利用内存缓存, 导致性能出现了问题。
<img src="https://pandora-dl.qiniu.com/grafana_memory.png" data-origin="https://pandora-dl.qiniu.com/grafana_memory.png" alt="memory"></p><h3 id="_6-kernel-信息"><span>6. kernel 信息</span></h3><p>kernel 基本信息中可以看到内核的上下文切换(context switch)、 fork 的进程数(forks)、 已打开(opened)/最大(max)句柄数等信息。通常情况下服务器打开的句柄数都有一个上限，超过了这个限制服务就会出现问题，而服务器的高并发访问极有可能导致打开的句柄数过多，实时监控句柄数有助于查看服务运行状况。
<img src="https://pandora-dl.qiniu.com/grafana_kernel.png" data-origin="https://pandora-dl.qiniu.com/grafana_kernel.png" alt="kernel"></p><h3 id="_7-cpu-的状态"><span>7. CPU 的状态</span></h3><p>在这张图中可以看到服务器中各个的<code>CPU</code>的状态，是对于 <code>CPU Usage</code> 的详细拓展。CPU 是一种弹性资源，即使使用量达到 100% 也不会出现直接的服务崩溃，但是极有可能导致服务响应变得极慢，密切关注 CPU 用量，并对于 CPU 设置报警监控也是运维必不可少的一环。
<img src="https://pandora-dl.qiniu.com/grafana_per_cpu.png" data-origin="https://pandora-dl.qiniu.com/grafana_per_cpu.png" alt="per cpu"></p><h3 id="_8-网络相关"><span>8. 网络相关</span></h3><ul>
<li>TCP </li>
</ul>
<p>这张图展示了系统中处于各个状态的 TCP 连接数量，比如<code>SYN SENT</code>、<code>FIN WAIT</code> 等, 利用这些数据可以及时发现请求的健康状态，常见的如出现大量的<code>FIN WAIT</code>、<code>CLOST WAIT</code>等状态的连接，说明出现了很多慢请求或连接有问题，需要排查，通常这一类指标可以结合打开文件句柄数一同查看。
<img src="https://pandora-dl.qiniu.com/grafana_tcp.png" data-origin="https://pandora-dl.qiniu.com/grafana_tcp.png" alt="tcp"></p><ul>
<li>ICMP、IPV4</li>
</ul>
<p>这张图中可以看到 <code>icmp</code>、<code>ipv4</code> 等网络协议的收发状态。
<img src="https://pandora-dl.qiniu.com/grafana_icmp.png" data-origin="https://pandora-dl.qiniu.com/grafana_icmp.png" alt="icmp"></p><ul>
<li>UDP</li>
</ul>
<p>这张图中可以看到 <code>udp 数据报</code> 以及 <code>udp</code> 错误数目等，如错误数过多，表示网络状况不佳。</p><p><img src="https://pandora-dl.qiniu.com/grafana_udp.png" data-origin="https://pandora-dl.qiniu.com/grafana_udp.png" alt="UDP"></p><ul>
<li>各个网卡的状态</li>
</ul>
<p>网卡状态展示了包括网卡收发数据的速度(Network Usage)、收发包的速度(Network Packets)、丢包率(Network drops)以及出错频率(Network errors)等信息。
<img src="https://pandora-dl.qiniu.com/grafana_interface.png" data-origin="https://pandora-dl.qiniu.com/grafana_interface.png" alt="interface"></p><h3 id="_9-交换分区状态"><span>9. 交换分区状态</span></h3><p>这张图展示了交换分区的换入换出状态、交换分区的使用情况等。
<img src="https://pandora-dl.qiniu.com/grafana_swap.png" data-origin="https://pandora-dl.qiniu.com/grafana_swap.png" alt="swap"></p><h3 id="_10-磁盘用量"><span>10. 磁盘用量</span></h3><p>磁盘的重要性毋庸置疑，磁盘爆满可能会对服务产生毁灭性打击，无疑也是需要监控的重点。</p><ul>
<li>磁盘 IO</li>
</ul>
<p>这张图给出了当前各个磁盘的 IO 信息，包括磁盘请求频率(Disk IO requests)、读写速度(Disk IO bytes)以及读写时间(Disk IO time)等，当磁盘 IO 过高时，也有可能存在性能问题，需要关注。
<img src="https://pandora-dl.qiniu.com/grafana_diskio.png" data-origin="https://pandora-dl.qiniu.com/grafana_diskio.png" alt="diskio"></p><ul>
<li>磁盘使用情况</li>
</ul>
<p>这张图中可以看到磁盘总空间(total)与已使用空间(used), 实时展现磁盘使用情况，并且可以设置告警机制，当磁盘的剩余空间少于某个阈值时及时告警。
<img src="https://pandora-dl.qiniu.com/grafana_disk.png" data-origin="https://pandora-dl.qiniu.com/grafana_disk.png" alt="disk"></p>